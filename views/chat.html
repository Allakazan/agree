<!doctype html>
<html>
<head>
    <title>{{ room.data.name }} server</title>
    <meta name="theme-color" content="#2f3136">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/global.css" />
    <link rel="stylesheet" type="text/css" href="/css/chat.css" />
    <link rel="stylesheet" type="text/css" href="/css/emoji.css" />
</head>
<body data-room-id="{{ room.id }}">
    <div class="container">
        <div class="sidebar">
            <div class="room-area" style="--bg-room: url({{ room.img }})">
                <h1>{{ room.data.name }} room</h1>
            </div>
            <div class="list-users-area">
                <p class="user-count">Na Sala - <span id="userCount" data-count=""></span></p>
                <ul class="connected-users"></ul>
            </div>            
            <div class="user-area">
                <div class="thumb-wrapper">
                    <a href="#"><img src=""/></a>
                </div>
                <div class="user-area-data">
                    <p class="username"></p>
                    <span class="userid"></span>
                </div>
            </div>
        </div>
        <div class="chat-wrapper">
            <div class="board-wrapper">
                <ul id="messages" class="message-wrapper"></ul>
            </div>
            <div class="bottom-section">
                <form action="">
                    <input id="inputMessage" type="text" autocomplete="off" placeholder="Talk in {{ room.data.name }} room" />
                </form>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/emoji-js/emoji.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hustcc/timeago.js@3.0.0/dist/timeago.min.js"></script>
    <script>
        (function () {

            let $ = (e) => document.querySelector(e)
            let userName = sessionStorage.getItem('selectedUsername')
            let roomId = document.body.dataset.roomId

            let timeAgo = new timeago()
            let emoji = new EmojiConvertor()
            emoji.use_sheet = true
            emoji.img_sets.apple.sheet = '/emoji-data/img/twitter/sheets/32.png';

            // Preload image
            new Image().src = emoji.img_sets.apple.sheet

            if (!userName) {
                window.location = "/"
            }

            let socket = io('/chat')

            let addConnectedUserList = function (user) {
                $('.connected-users').insertAdjacentHTML(
                    'beforeend',
                    `<li data-id="${user.id}">
                        <div class="c-thumb-wrapper">
                            <a href="#"><img src="${user.avatar}"/></a>
                        </div>
                        <div class="c-user-area-data">
                            <p class="c-username">${user.name}</p>
                            <span class="c-userid">${user.usertag}</span>
                        </div>
                    </li>`
                )
            }

            let parseMessage = function(str) {

                str = str.replace(/(\*\*(.*?)\*\*)/g, function(match) {
                    return '<b>'+match.slice(2,-2)+'</b>'
                })

                str = str.replace(/(\_\_(.*?)\_\_)/g, function(match) {
                    return '<i>'+match.slice(2,-2)+'</i>'
                })

                str = str.replace(/(\~\~(.*?)\~\~)/g, function(match) {
                    return '<s>'+match.slice(2,-2)+'</s>'
                })

                str = emoji.replace_colons(str)

                return str
            }

            socket.on('connect', () => {
                socket.emit('join-request', { roomId: roomId, userName: userName })
            })

            socket.on('new-user-joined-room', function (joinedUser) {
                if (joinedUser.id == socket.id) {
                    $('.user-area .thumb-wrapper img').setAttribute('src', joinedUser.avatar)
                    $('.user-area .user-area-data .username').innerHTML = joinedUser.name
                    $('.user-area .user-area-data .userid').innerText = joinedUser.usertag

                    socket.emit('get-all-users-in-room', joinedUser.room, function (joinedUsers) {
                        // Fallback for node restart bugs
                        $(".connected-users").innerHTML = ''

                        Object.keys(joinedUsers).map(function(userId) {
                            addConnectedUserList(joinedUsers[userId])
                        })
                        $("#userCount").dataset.count = Object.keys(joinedUsers).length
                    })
                } else {
                    addConnectedUserList(joinedUser)
                    $("#userCount").dataset.count = parseInt($("#userCount").dataset.count) + 1
                }
            })

            socket.on('user-disconnected', function (id) {
                $(".connected-users li[data-id='"+id+"']").remove()
                $("#userCount").dataset.count = parseInt($("#userCount").dataset.count) - 1
            })

            $('form').addEventListener('submit', function (e) {
                e.preventDefault()
                socket.emit('send-message', { roomId: roomId, msg: $('#inputMessage').value })

                $('#inputMessage').value = ''

                return false
            })

            socket.on('new-message', function (data) {
                $('#messages').insertAdjacentHTML(
                    'beforeend',
                    `<li>
                        <div class="image-wrapper">
                            <img src="${data.sender.avatar}"/>
                        </div>
                        <div class="text-wrapper">
                            <p class="title">${data.sender.name} <span class="date timeago" datetime="${data.timestamp}"></span></p>
                            <p class="msg">${parseMessage(data.msg)}</p>  
                        </div>
                    </li>`
                )

                timeAgo.render(document.querySelector('#messages li:last-child .timeago'));

                $('.board-wrapper').scrollTop = $('.board-wrapper').scrollHeight;
            })

        })()
    </script>
</body>

</html>